<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: decider.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: decider.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var util = require('util'),
    DecisionTask = require('./decision-task').DecisionTask,
    _ = require('lodash'),
    Poller = require('./poller').Poller;

/**
 * Decider polls Amazon SWF for new Decision Tasks
 * @constructor
 * @param {Object} config Ex: { domain: "my-domain", taskList: {name: "my-taskList"} }
 * @param {Object} [swfClient]
 * @augments Poller
 * @fires Decider#decisionTask
 * @fires Poller#poll
 * @fires Poller#error
 */
var Decider = exports.Decider = function (config, swfClient) {

    Poller.call(this, config, swfClient);

    if (!config.domain || !config.taskList) {
        throw "Decider: domain and taskList must be set";
    }

    // For the Poller class
    this.pollMethod = "pollForDecisionTask";
};

util.inherits(Decider, Poller);

/**
 * Callback for incoming tasks
 * @private
 * @param {Object} [originalResult] configuration object for the task
 */
Decider.prototype._onNewTask = function(originalResult,result,_this, events) {
    //For the first call, events will not be passed.
    events = events || [];
    //Reference to the original this object.
    _this = _this || this;
    result = result || originalResult;
    events.push.apply(events,result.events);
    //If more pages are available, make call to fetch objects
    if(result.nextPageToken) {
        var pollConfig = _.clone(this.config);
        pollConfig.nextPageToken = result.nextPageToken;
        this.swfClient.client[this.pollMethod](pollConfig, function (err, nextPageResult) {
            if (err) {
                _this.emit('error', err);
                return;
            }
            _this._onNewTask(originalResult,nextPageResult,_this,events);

        });
    } else {
        //No more pages available. Create decisionTask.
        var decisionTask = new DecisionTask(originalResult, this.swfClient,events);

        /**
         * Emitted for every decision task received from Amazon SWF
         *
         * @event Decider#decisionTask
         * @property {DecisionTask} decisionTask
         */
        this.emit('decisionTask', decisionTask);
    }

};

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="ActivityPoller.html">ActivityPoller</a></li><li><a href="ActivityTask.html">ActivityTask</a></li><li><a href="Decider.html">Decider</a></li><li><a href="DecisionResponse.html">DecisionResponse</a></li><li><a href="DecisionTask.html">DecisionTask</a></li><li><a href="EventList.html">EventList</a></li><li><a href="Poller.html">Poller</a></li><li><a href="Workflow.html">Workflow</a></li><li><a href="WorkflowExecution.html">WorkflowExecution</a></li></ul><h3>Events</h3><ul><li><a href="ActivityPoller.html#event:activityTask">activityTask</a></li><li><a href="ActivityPoller.html#event:error">error</a></li><li><a href="ActivityPoller.html#event:poll">poll</a></li><li><a href="Decider.html#event:decisionTask">decisionTask</a></li><li><a href="Decider.html#event:error">error</a></li><li><a href="Decider.html#event:poll">poll</a></li><li><a href="Poller.html#event:error">error</a></li><li><a href="Poller.html#event:poll">poll</a></li></ul><h3>Global</h3><ul><li><a href="global.html#createClient">createClient</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha4</a> on Fri Feb 28 2014 16:54:55 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
